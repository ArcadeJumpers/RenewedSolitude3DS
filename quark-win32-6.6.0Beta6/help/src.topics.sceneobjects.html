<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
  <title>Sceneobjects</title>
  <meta name="Description" content="QuArK Information Database - Page: 4.4.9.&nbsp;Sceneobjects">
  <meta name="Keywords" content="QuArK InfoBase Quake Army Knife QRK QKM Python PY Map Editor Hexen Heretic Half-Life Sin Kingpin Soldier-of-Fortune Star-Trek-Voyager Elite-Force">
  <link rel=stylesheet href="standard.css" type="text/css">
</head>

<body>
<a name="__top__"></a>
<table width="100%" border=0 cellspacing=0>
  <tr>
    <td width=213>
      <a target="_blank" href="http://quark.sourceforge.net/"><img src="quarkicon.png" width=213 height=90 border=0 alt="Go to QuArK Web Site"></a>
    </td>
    <td width="70%" align=center>
      <div class="topheadline">Sceneobjects</div>
      <div class="sm">Updated&nbsp;20 Sep 2008</div>
    </td>
    <td width="30%" valign=bottom nowrap>
      Upper&nbsp;levels:<br>-&nbsp;<a href="index.html">QuArK&nbsp;Information&nbsp;Base</a><br>-&nbsp;<a href="src.html">4.&nbsp;The&nbsp;Source&nbsp;Code</a><br>-&nbsp;<a href="src.topics.html">4.4.&nbsp;Specific&nbsp;Topics</a><br>
    </td>
  </tr>
</table>
<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="99%">
      <p class="headline">&nbsp;4.4.9.&nbsp;Sceneobjects</p>
    </td>
    <td width="1%" align=right nowrap>
      &nbsp;[&nbsp;<span class="navenable"><a href="src.topics.logging.html">Prev</a></span>&nbsp;-&nbsp;<span class="navenable"><a href="src.topics.html">Up</a></span>&nbsp;-&nbsp;<span class="navenable"><a href="src.pas.html">Next</a></span>&nbsp;]&nbsp;
    </td>
  </tr>
</table>
<table border=0 width="100%" cellspacing=10><tr><td><p>This document tries to describe the inner workings of the 3D scene objects.
</p>
</td></tr></table>
<br>

<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="100%">
      <p class="subheadline">&nbsp;Index</p>
    </td>
  </tr>
</table>
<ul class="index">
  <li>- <a href="#addto3dscene">AddTo3DScene</a>&nbsp;<span class="added">(20 Sep 2008)</span>
  <li>- <a href="#tsceneobject">TSceneObject</a>&nbsp;<span class="added">(20 Sep 2008)</span>
  <li>- <a href="#buildscene">BuildScene</a>&nbsp;<span class="added">(20 Sep 2008)</span>
</ul>
<br>


<a name="addto3dscene"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;AddTo3DScene</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;20 Sep 2008</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>AddTo3DScene is the method of map objects whereby the map structure
builds the 3d scene.  The real work is done by methods such as
TFace.AddTo3DScene in prog/QkMapPoly.pas [tig: what is the correct name for
a subclass's implementation of a virtual method?]; we see that
the workhorse line is:
</p><p>        CurrentMapView.Scene.AddPolyFace(P);
</p><p>CurrentMapView is a global variable of type TPyMapView defined by
this line of python/PyMapView.pas:
</p><p> CurrentMapView : TPyMapView = TPyMapView(-1);
</p><p>A TPyMapView is a subclass of TScrollBox, I presume the -1 is setting
its owner to nothing [tig: check this].  For some reason, Scene is a property
whose read method is FScene, whose value is a TSceneObject.
</p>
  </td></tr></table>
  <br>

<a name="tsceneobject"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;TSceneObject</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;20 Sep 2008</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>TSceneObject defined in 3dfx/EdSceneObject.pas, with subclasses:
</p><p>  3dfx\EdSoftware.pas(183): TSoftwareSceneObject = class(TSceneObject)
  3dfx\EdGlide.pas(178): TGlideSceneObject = class(TSceneObject)
  3dfx\EdOpenGL.pas(181): TGLSceneBase = class(TSceneObject)
  3dfx\EdDirect3D.pas(78): TDirect3DSceneObject = class(TSceneObject)
</p><p>  Note: Line numbers will change as history is added to the front of the file.
</p><p>The first is the class for the software, the second for Glide (3dfx) 3d
textured views, the third for the OpenGL one, and the last is the start of
an unfinished projet to produce a Direct3D view; the appropriate
constructors are called by python/PyMapView:TPyMapView.NeedScene.
</p><p>There also are several files that are used by the renderers:
</p><p>  3dfx\Glide.pas     (Used by Software and Glide)
  3dfx\GL1.pas     (Used by OpenGL)
  3dfx\Direct3D9.pas     (Used by Direct3D)
  3dfx\Direct3D.pas     (Used by Direct3D)
  3dfx\DirectDraw.pas     (Used by Direct3D)
  3dfx\DX9.pas     (Used by Direct3D)
  3dfx\DXErr9.pas     (Used by Direct3D)
  3dfx\DXTypes.pas     (Used by Direct3D)
</p><p>EdSceneObject.pas:  This is divided into two sections, one concerned
with TSceneObject, the other with TTexture Manager.  The interesting
non-virtual method is BuildScene, which is very big - Armin seems
to often have gone for extremely long functions, which are supposed to
be bad style, so perhaps we could think about breaking this one
up into intelligible bits?
</p><p>An important type in 3d scene building is PSurface, defined in
prog/QkMapPoly.pas, which defines a visible polyhedron face.  It
is a pointer to a TSurface, defined as follows:
</p><p>TSurface = record
             Source: TTreeMap;
             F: TFace;
             NextF: PSurface;   { linked list of PSurfaces for a given face }
             prvVertexCount: Integer;
             prvVertexTable: TFVertexTable;
            end;
</p><p>Each face has a linked list of PSurfaces because of face-sharing. F is
used to get info about the texture-name, etc., Source isn't used by
this module.  The PSurfaces are rebuilt by code in QkMapPoly.pas.
</p><p>The AddSurfaceRef sub-procedure of BuildScene adds a surface to a master-list
of surfaces, TSceneObject.FListSurfaces, accesible also as read-property
ListSurfaces. Need to understand BuildScene to see what this does.
</p><p>Questions about TSceneObject:
</p><p>  how does BuildScene work?
  what is SetColor do for?
  what is the purpose of ChangeQuality?
    It seems to be related to cutting the resolution in half in the software
    renderer.
</p>
  </td></tr></table>
  <br>

<a name="buildscene"></a>
  <table width="100%" border=0 cellspacing=0>
    <tr class="headline">
      <td>
        <p class="item">&nbsp;BuildScene</p>
      </td>
      <td align=right>
        <font size=-2>tiglari&nbsp;-&nbsp;20 Sep 2008</font>
      </td>
      <td width="1%" align=right nowrap>
        &nbsp;&nbsp;[&nbsp;<a href="#__top__">Top</a>&nbsp;]&nbsp;
      </td>
    </tr>
  </table>
  <table border=0 width="100%" cellspacing=10><tr><td>
<p>  If a 3d window is open, gets called every time anything happens to the
   views.  This seems excessive, for example for a selection event very little
   gets changed.
</p><p>  1.  some initializations:
         Held over from previous BuildScene:
           TextureManager
         Reinitialized:
           TexNames list
           FlistSurfaces - done via linked list freeing, maybe a slowdown factor?
           nVertexList and nVertexList2
</p><p>  2.  scan the map objects and build the TexNames list, which gives
        information about surfaces indexed by the TexNames, and
        also add this information to the FlistSurfaces list.
</p><p>      Problem: the info specifyies how much info is needed to store
      the vertexes of the faces using the texture, but no info about
      those vertexes seems to be recorded.
</p>
<p>  3.  rebuild the old textures, note how many new ones needed.
        Q: what does building do?
</p><p>  4.  free old textures no longer needed
</p><p>  5.  load and build new textures
</p><p>  6.  build a lot of stuff
</p><p>  7.  for each face, load a lot of stuff into the appropriate
        surf3d element [some of it looks like texture coordinates]
</p><p>  8.  ditto for models, sprites and beziers
        lots of rather repetitive-looking code.
</p><p>  9.  and a bit of final cleanup.
</p><p>More understanding of what goes on in steps 6-8 is needed here.
</p>
  </td></tr></table>
  <br>

<br>

<table width="100%" border=0 cellspacing=0>
  <tr class="headline">
    <td width="99%" align=center>
      <p class="sm">
        Copyright (c) 2009, GNU General Public License by The QuArK (Quake Army Knife) Community - <a target="_blank" href="http://quark.sourceforge.net/">http://quark.sourceforge.net/</a><br>
      </p>
    </td>
    <td width="1%" align=right nowrap>
      &nbsp;[&nbsp;<span class="navenable"><a href="src.topics.logging.html">Prev</a></span>&nbsp;-&nbsp;<a href="#__top__">Top</a>&nbsp;-&nbsp;<span class="navenable"><a href="src.pas.html">Next</a></span>&nbsp;]&nbsp;
    </td>
  </tr>
</table>
</body>
</html>